# Task Runner MCP Server 開発計画

## 概要
本ドキュメントでは、Task Runner MCP Serverの開発を8つのIssueに分割し、各Issueを2時間以内で完了できるサイズで定義します。

## Issue一覧

### Issue #1: プロジェクト初期セットアップ

**目的**: TypeScript開発環境の基盤構築

**実施内容**:
- package.jsonの作成
  - 必要な依存関係の定義（最新バージョン）
  - npm scriptsの設定（build, dev, lint, test）
- TypeScript設定（tsconfig.json）
  - strict modeの有効化
  - ES2022ターゲット設定
- ESLint/Prettier設定
  - TypeScript対応
  - MCPプロジェクト向けルール
- 基本ディレクトリ構造の作成
  - src/, tests/, logs/ディレクトリ
- .gitignoreの設定
  - node_modules, dist, logs除外

**受け入れ条件**:
- `npm install`が正常に完了すること
- `npm run build`でビルドが成功すること
- `npm run lint`でエラーが発生しないこと
- `npm test`でテストが実行できること

**参照ドキュメント**:
- docs/requirements.md（技術スタック部分）

---

### Issue #2: ログシステムの実装

**目的**: すべてのMCP通信を記録する基盤構築

**実施内容**:
- src/logger/Logger.tsの実装
  - ComprehensiveLogインターフェースの定義
  - JSON-RPCメッセージの記録機能
  - ワークフロー状態の記録機能
- JSONL形式でのファイル出力実装
  - ストリーミング書き込み
  - ファイル名規則の実装
- コンソール出力機能（開発用）
  - 色付き出力
  - ログレベル制御
- ユニットテストの作成
  - ログ出力の検証
  - ファイル書き込みの確認

**受け入れ条件**:
- ログがJSONL形式でファイルに出力されること
- タイムスタンプ、セッションID、シーケンス番号が正しく記録されること
- コンソール出力が読みやすい形式で表示されること
- すべてのユニットテストがパスすること

**参照ドキュメント**:
- 本会話内の「完全ログ出力の設計」セクション

---

### Issue #3: MCPサーバー基本実装

**目的**: MCPプロトコルに準拠したサーバーの起動

**実施内容**:
- src/index.tsの作成
  - MCPサーバーの初期化
  - 基本的な設定
- MCPサーバーインスタンスの作成
  - @modelcontextprotocol/sdkの使用
  - stdioトランスポート設定
- ログシステムとの統合
  - すべてのメッセージをログに記録
  - エラーハンドリング
- 基本的なツール登録の枠組み
  - ツール登録メソッドの実装
  - 空のツールリスト

**受け入れ条件**:
- `npm run dev`でサーバーが起動すること
- MCP Inspectorから接続可能なこと
- すべての通信がログに記録されること
- Ctrl+Cで正常に終了すること

**参照ドキュメント**:
- @modelcontextprotocol/sdk公式ドキュメント
- docs/mcp-todowrite-replacement-guide.md

---

### Issue #4: ワークフロー状態管理の実装

**目的**: 6フェーズのワークフロー状態を管理

**実施内容**:
- src/workflow/WorkflowManager.tsの実装
  - WorkflowStateインターフェースの定義
  - 状態遷移ロジックの実装
- フェーズ定義
  - 6つのフェーズの定義
  - 各フェーズの前提条件と受け入れ条件
- 作業対象ファイルの管理機能
  - ファイルリストの更新
  - フェーズ間での引き継ぎ
- 型定義ファイル（src/types/workflow.ts）
  - PhaseInstruction型
  - PhaseResult型
  - その他の関連型

**受け入れ条件**:
- 各フェーズへの遷移が正しく動作すること
- 不正な状態遷移でエラーが発生すること
- 作業対象ファイルが正しく引き継がれること
- ユニットテストで全フェーズの遷移が確認できること

**参照ドキュメント**:
- docs/requirements.md（ワークフロー仕様）

---

### Issue #5: startIssueWorkflowツールの実装

**目的**: Issue作業を開始するMCPツール

**実施内容**:
- src/tools/startIssueWorkflow.tsの実装
  - ツール定義とスキーマ（Zod使用）
  - 入力パラメータ: issueNumber
- WorkflowManagerとの連携
  - 新しいワークフローの開始
  - 初期フェーズへの遷移
- 構造化された指示の生成
  - Issue確認フェーズの指示
  - 前提条件、受け入れ条件、タスクの設定
- エラーハンドリング
  - 既存ワークフローの検出
  - 不正な入力の処理

**受け入れ条件**:
- MCP Inspectorからツールが呼び出せること
- 正しい指示形式（PhaseInstruction）が返されること
- ログに完全な情報が記録されること
- 重複開始時にエラーが発生すること

**参照ドキュメント**:
- 本会話内の「構造化された指示形式」セクション

---

### Issue #6: completePhaseツールの実装

**目的**: フェーズ完了報告と次フェーズへの遷移

**実施内容**:
- src/tools/completePhase.tsの実装
  - ツール定義とスキーマ
  - 入力: PhaseResult（完了報告）
- フェーズ完了処理
  - 現在フェーズの完了記録
  - 作業対象ファイルの更新
- 次フェーズへの遷移
  - 遷移ルールの適用
  - 次の指示の生成
- 特殊ケースの処理
  - 最終フェーズの完了
  - CIエラー時の修正フェーズへの遷移

**受け入れ条件**:
- フェーズ完了が正しく記録されること
- 適切な次フェーズに遷移すること
- 最終フェーズで完了状態になること
- CI失敗時に修正フェーズに遷移すること

**参照ドキュメント**:
- docs/requirements.md（フェーズ遷移仕様）

---

### Issue #7: 情報取得ツールの実装

**目的**: 現在の状態を確認するツール群

**実施内容**:
- src/tools/getCurrentPhase.tsの実装
  - 現在のフェーズ情報を返す
  - 現在の指示内容も含める
- src/tools/getWorkflowStatus.tsの実装
  - 全体の進捗状況
  - 完了フェーズのリスト
  - 作業対象ファイル一覧
- エラー情報の取得機能
  - 最新のエラー情報
  - エラー履歴
- 統合テストの作成
  - 全ツールの連携確認

**受け入れ条件**:
- 現在のフェーズが正しく取得できること
- 全体の進捗が確認できること
- エラー状態が適切に報告されること
- すべての情報がログと一致すること

**参照ドキュメント**:
- 本会話内の「MCPツール設計」セクション

---

### Issue #8: Claude Code統合とドキュメント

**目的**: Claude Codeから使用可能な状態にする

**実施内容**:
- Claude Code用のMCP設定調査
  - 環境変数の確認
  - 設定ファイルの場所
- README.mdの作成
  - インストール手順
  - Claude Code向け設定手順
  - 使用例（サンプルワークフロー）
- 使用方法のドキュメント
  - 各ツールの説明
  - ワークフローの流れ
  - ログの確認方法
- トラブルシューティングガイド
  - よくある問題と解決方法
  - デバッグ方法

**受け入れ条件**:
- Claude Codeから接続して使用できること
- ドキュメントに従って設定が完了できること
- 基本的な使用例が動作すること
- ログ出力が正しく記録されること

**参照ドキュメント**:
- Claude Code MCPドキュメント
- https://docs.anthropic.com/en/docs/claude-code/mcp

---

## 開発順序の推奨

1. Issue #1 → #2 → #3（基盤構築）
2. Issue #4（ワークフロー管理）
3. Issue #5 → #6 → #7（ツール実装）
4. Issue #8（統合とドキュメント）

各Issueは独立性を保ちつつ、前のIssueの成果物を活用する設計になっています。