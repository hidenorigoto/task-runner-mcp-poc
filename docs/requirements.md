# Task Runner MCP Server 要件定義書

## 1. プロジェクト概要

### 1.1 目的
AIエージェント（Claude Code）でコーディングを行う際の作業プロセスを確実に管理・制御するためのMCPサーバーを開発する。プロンプトによる指示の限界を克服し、構造化されたワークフローを強制実行することで、品質の高い開発プロセスを実現する。

### 1.2 背景
現状の課題：
- プロンプトによる指示では、エージェントが手順をスキップする可能性がある
- 毎回同じ指示を繰り返す必要があり、トークンを無駄に消費する
- 品質チェックや振り返りなどの重要なステップが忘れられることがある

### 1.3 スコープ
- **PoC段階**: GitHub Issue単位の作業フロー管理
- **将来拡張**: より大きな粒度のワークフロー、外部定義ファイルによる柔軟な設定

## 2. 機能要件

### 2.1 ワークフロー管理

#### 2.1.1 固定ワークフロー（6フェーズ）

1. **Issue作業開始フェーズ**
   - Issue番号を指定して作業開始
   - Issue内容の取得と表示
   - 作業内容の批判的レビュー

2. **実装フェーズ**
   - コード変更の実施
   - 作業対象ファイルの管理

3. **品質チェックフェーズ**
   - lintの実行
   - 型チェックの実行
   - ユニットテストの実行
   - E2Eテストの実行（存在する場合）

4. **PR作成フェーズ**
   - ブランチの確認
   - Pull Request作成
   - CI結果の監視

5. **修正フェーズ**（CIが失敗した場合）
   - エラー内容の確認
   - 修正の実施
   - 再度品質チェック

6. **完了フェーズ**
   - PRのマージ
   - 振り返りコメントの作成
   - Issueへのコメント投稿

#### 2.1.2 構造化された指示形式

各フェーズでエージェントに提供する情報：

```typescript
interface PhaseInstruction {
  phaseName: string;
  preconditions: string[];      // 前提条件
  acceptanceCriteria: string[]; // 受け入れ条件
  tasks: string[];              // 作業内容
  context?: any;                // フェーズ固有の追加情報
}
```

### 2.2 状態管理

#### 2.2.1 ワークフロー状態

```typescript
interface WorkflowState {
  issueNumber: string;
  currentPhase: string;
  workingFiles: string[];      // 作業対象ファイルのリスト
  phaseHistory: PhaseResult[];
}
```

#### 2.2.2 作業対象ファイルの引き継ぎ
- 各フェーズで修正・追加されたファイルを記録
- 次のフェーズに作業対象ファイルを引き継ぐ

### 2.3 MCPツール

1. **startIssueWorkflow(issueNumber: string)**
   - Issue作業を開始し、最初のフェーズへ移行

2. **completePhase(phaseResult: PhaseResult)**
   - 現在のフェーズの完了を報告
   - 次のフェーズへの移行判定

3. **getCurrentPhase()**
   - 現在のフェーズと必要なアクションを返す

4. **getWorkflowStatus()**
   - 全体の進捗状況を取得

## 3. 非機能要件

### 3.1 ログ要件

#### 3.1.1 完全ログ記録
すべてのやり取りを記録：
- JSON-RPCの全メッセージ（request/response）
- ツール呼び出しの完全な入出力
- 内部状態の変化
- エラーとスタックトレース
- タイミング情報（実行時間）

#### 3.1.2 ログ形式
- ファイル出力: JSONL形式
- コンソール出力: 開発時の確認用（JSON整形表示）
- ファイル名: `logs/mcp-{sessionId}-{timestamp}.jsonl`

### 3.2 パフォーマンス要件
- 各ツール呼び出しのレスポンス: 1秒以内
- ログ記録によるオーバーヘッド: 最小限

### 3.3 互換性要件
- Claude Code との統合（環境変数: `CLAUDE_CODE_MCP_ENABLED=1`）
- MCP Inspector での動作確認

## 4. 技術仕様

### 4.1 技術スタック
- **言語**: TypeScript 5.8
- **実行環境**: Node.js 22.x LTS
- **MCPフレームワーク**: @modelcontextprotocol/sdk 1.13.2
- **テストフレームワーク**: Vitest 3.2.4
- **コード品質**: ESLint 9.x, Prettier 3.x
- **型検証**: Zod 3.x

### 4.2 プロジェクト構造
```
task-runner-mcp-poc/
├── src/
│   ├── index.ts          # MCPサーバーエントリポイント
│   ├── workflow/         # ワークフロー管理
│   ├── tools/           # MCPツール定義
│   ├── logger/          # ログシステム
│   └── types/           # 型定義
├── logs/                # ログ出力ディレクトリ
├── tests/               # テストファイル
├── docs/                # ドキュメント
├── package.json
├── tsconfig.json
└── vitest.config.ts
```

## 5. 制約事項

### 5.1 PoC段階の制約
- ワークフローは固定（ハードコード）
- 単一Issueのみ対応（並行作業なし）
- 状態はメモリ上で管理（永続化なし）
- ローカル環境での動作のみ

### 5.2 責任分担
- **MCPサーバー**: ワークフロー制御、状態管理、指示の提供
- **エージェント**: 実作業の実行、判断、受け入れ条件の達成確認

## 6. 将来の拡張計画

1. **ワークフローの外部定義**
   - YAMLまたはJSONファイルでワークフローを定義
   - プロジェクトごとのカスタマイズ

2. **複数Issue対応**
   - 並行作業のサポート
   - Issue間の依存関係管理

3. **状態の永続化**
   - 中断・再開機能
   - 作業履歴の長期保存

4. **高度な分析機能**
   - ワークフロー実行の統計
   - ボトルネックの特定